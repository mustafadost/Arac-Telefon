<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Araç QR Sistemi</title>

<style>
body{
  font-family:Arial;
  background:linear-gradient(135deg,#1d2671,#c33764);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.card{
  background:#fff;
  padding:30px;
  border-radius:20px;
  width:380px;
  box-shadow:0 15px 40px rgba(0,0,0,0.3);
}
.plaka{
  font-size:28px;
  font-weight:900;
  text-align:center;
  border:3px solid #1d2671;
  padding:12px;
  border-radius:12px;
  margin-bottom:20px;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}
.ara{background:#28a745;color:white;font-size:18px;padding:18px;}
.acil{background:#dc3545;color:white;}
.cam{background:#ffc107;}
.park{background:#17a2b8;color:white;}
.toggle{background:#6f42c1;color:white;}
input{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ccc;}
</style>
</head>
<body>
<div class="card" id="app"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwh2J-Z6Qpyrc3rb5jVzQ0DVyiBMb9phYeAqH4fRfCZmtEW2_9duX1WsW6D1o_lEqVXng/exec";
const qr=new URLSearchParams(location.search).get("qr");
const app=document.getElementById("app");
let currentPlaka="";
let currentTelefon="";
let currentDurum="";

if(!qr){ app.innerHTML="<h3>QR bulunamadı</h3>"; }

fetch(API+"?action=get&qr="+qr)
.then(r=>r.json())
.then(d=>{
  if(!d.kayit){
    app.innerHTML=`
      <h3>Kayıt Ol</h3>
      <input id="plaka" placeholder="Plaka">
      <input id="telefon" placeholder="Telefon">
      <input id="sifre" placeholder="Şifre">
      <button onclick="register()">Kaydet</button>
    `;
  }else{
    if(d.durum=="pasif"){
      app.innerHTML=`<div class="plaka">${d.plaka}</div>
      <button onclick="login()">Araç Sahibi Giriş</button>`;
    }else{
      currentPlaka=d.plaka;
      currentTelefon=d.telefon;
      currentDurum=d.durum;
      showButtons();
    }
  }
});

function register(){
  fetch(API+"?action=register",{
    method:"POST",
    body:JSON.stringify({
      qr:qr,
      plaka:document.getElementById("plaka").value,
      telefon:document.getElementById("telefon").value,
      sifre:document.getElementById("sifre").value
    })
  }).then(()=>location.reload());
}

function login(){
  const sifre=prompt("Şifre giriniz:");
  fetch(API+"?action=login",{
    method:"POST",
    body:JSON.stringify({qr:qr,sifre:sifre})
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      currentPlaka=d.plaka;
      currentTelefon=d.telefon;
      currentDurum=d.durum;
      showButtons(true);
    }else{
      alert("Şifre hatalı");
    }
  });
}

function showButtons(owner=false){
  app.innerHTML=`
    <div class="plaka">${currentPlaka}</div>
    <button class="ara" onclick="mesaj('ara')">Sürücüyü Ara</button>
    <button class="acil" onclick="mesaj('acil')">Acil</button>
    <button class="cam" onclick="mesaj('cam')">Cam Açık</button>
    <button class="park" onclick="mesaj('park')">Yanlış Park</button>
    ${owner?'<button class="toggle" onclick="toggle()">Aktif/Pasif Yap</button>':''}
  `;
}

function toggle(){
  fetch(API+"?action=toggle",{
    method:"POST",
    body:JSON.stringify({plaka:currentPlaka})
  }).then(()=>location.reload());
}

function mesaj(tip){
  let m="";
  if(tip=="acil") m=`ACİL DURUM! ${currentPlaka} plakalı aracınızla ilgili acil bir durum var.`;
  if(tip=="cam") m=`Bilgilendirme: ${currentPlaka} plakalı aracınızın camı açık görünüyor.`;
  if(tip=="park") m=`Bilgilendirme: ${currentPlaka} plakalı aracınız hatalı park etmiş olabilir.`;
  if(tip=="ara") m=`${currentPlaka} plakalı aracınızla ilgili iletişim kurulmak isteniyor.`;
  window.location.href="https://wa.me/90"+currentTelefon+"?text="+encodeURIComponent(m);
}
</script>
</body>
</html>
