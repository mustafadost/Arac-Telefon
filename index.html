<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR AraÃ§ Ä°letiÅŸim</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card{
  background:rgba(255,255,255,0.15);
  backdrop-filter:blur(15px);
  padding:25px;
  border-radius:20px;
  width:95%;
  max-width:420px;
  color:white;
  box-shadow:0 8px 25px rgba(0,0,0,0.3);
}
h2{text-align:center;margin-top:0}
input{
  width:100%;
  padding:12px;
  margin:8px 0;
  border:none;
  border-radius:8px;
}
button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border:none;
  border-radius:10px;
  font-size:15px;
  cursor:pointer;
}
.primary{background:#25D366;color:white;}
.red{background:#e74c3c;color:white;}
.blue{background:#3498db;color:white;}
.gray{background:#555;color:white;}
.link{
  text-align:center;
  margin-top:10px;
  cursor:pointer;
  font-size:14px;
  opacity:0.8;
}
.small{font-size:13px;text-align:center;margin-top:10px}
</style>
</head>

<body>

<div class="card">
  <div id="content">YÃ¼kleniyor...</div>
</div>

<script>

const API = "https://script.google.com/macros/s/AKfycbwwJAi9nBV361Gx7MnNdUuX5HU6POIqMfyxHKKymK4OUM419DIQKyhiMbB922aNUemd-Q/exec";

const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if(!id){
  document.getElementById("content").innerHTML="QR HatalÄ±.";
}else{
  kontrol();
}

function kontrol(){
fetch(`${API}?action=kontrol&id=${id}`)
.then(res=>res.json())
.then(data=>{

  if(data.kayit){
    kayitForm();
  }
  else if(data.menu){
    menu(data.telefon);
  }
  else if(data.pasif){
    document.getElementById("content").innerHTML=
    "<h2>Ä°letiÅŸim KapalÄ±</h2><div class='small'>AraÃ§ sahibi iletiÅŸimi devre dÄ±ÅŸÄ± bÄ±rakmÄ±ÅŸ.</div>"+altMenu();
  }
  else{
    document.getElementById("content").innerHTML="ID bulunamadÄ±.";
  }

});
}

function kayitForm(){
document.getElementById("content").innerHTML=`
<h2>KayÄ±t OluÅŸtur</h2>
<input id="plaka" placeholder="Plaka">
<input id="ad" placeholder="Ad Soyad">
<input id="telefon" placeholder="Telefon 05xx...">
<input id="sifre" type="password" placeholder="Åžifre">
<button class="primary" onclick="kaydet()">Kaydet</button>
${altMenu()}
`;
}

function kaydet(){
fetch(API,{
method:"POST",
body:JSON.stringify({
action:"kayit",
id:id,
plaka:plaka.value,
ad:ad.value,
telefon:telefon.value,
sifre:sifre.value
})
})
.then(res=>res.json())
.then(d=>{
if(d.success){
alert("KayÄ±t tamamlandÄ±.");
kontrol();
}
});
}

function menu(tel){
let mesaj=(text)=>`https://wa.me/${tel}?text=${encodeURIComponent(text)}`;

document.getElementById("content").innerHTML=`
<h2>Ä°letiÅŸim</h2>
<button class="red" onclick="window.location='${mesaj("Acil durum nedeniyle aracÄ±nÄ±za ulaÅŸmaya Ã§alÄ±ÅŸÄ±yorum.")}'">ðŸš¨ Acil Durum</button>
<button class="blue" onclick="window.location='${mesaj("AracÄ±nÄ±z yanlÄ±ÅŸ park edilmiÅŸ.")}'">ðŸš— YanlÄ±ÅŸ Park</button>
<button class="blue" onclick="window.location='${mesaj("AracÄ±nÄ±zÄ±n camlarÄ± aÃ§Ä±k kalmÄ±ÅŸ.")}'">ðŸŒ¬ Camlar AÃ§Ä±k</button>
<button class="primary" onclick="window.location='tel:${tel}'">ðŸ“ž SÃ¼rÃ¼cÃ¼yÃ¼ Ara</button>
${altMenu()}
`;
}

function altMenu(){
return `
<div class="small">
<hr>
<h4>Durum GÃ¼ncelle</h4>
<input id="p2" placeholder="Plaka">
<input id="s2" type="password" placeholder="Åžifre">
<button class="gray" onclick="durum()">Aktif/Pasif DeÄŸiÅŸtir</button>
<div class="link" onclick="admin()">Admin</div>
</div>`;
}

function durum(){
fetch(API,{
method:"POST",
body:JSON.stringify({
action:"durum",
plaka:p2.value,
sifre:s2.value
})
})
.then(r=>r.json())
.then(d=>{
if(d.success){
alert("Yeni Durum: "+d.durum);
kontrol();
}else{
alert("Bilgiler hatalÄ±");
}
});
}

function admin(){
let sifre=prompt("Admin Åžifre:");
fetch(`${API}?action=adminLogin&sifre=${sifre}`)
.then(r=>r.json())
.then(d=>{
if(d.success){
adminPanel();
}else{
alert("HatalÄ± Åžifre");
}
});
}

function adminPanel(){
fetch(`${API}?action=adminListe`)
.then(r=>r.json())
.then(d=>{
let html="<h2>Admin Panel</h2>";
d.liste.forEach(k=>{
html+=`<div style="margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.2)">
${k.id}<br>${k.plaka}<br>${k.telefon}<br>${k.durum}<br><br></div>`;
});
html+="<button class='primary' onclick='kontrol()'>Kapat</button>";
document.getElementById("content").innerHTML=html;
});
}

</script>

</body>
</html>
