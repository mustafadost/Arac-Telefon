<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AraÃ§ Ä°letiÅŸim</title>

<style>
body{
  font-family:Arial;
  background:#f4f4f4;
  padding:20px;
  margin:0;
}
h1{
  text-align:center;
  font-size:32px;
}
input{
  width:100%;
  padding:12px;
  margin:8px 0;
  font-size:16px;
}
button{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:16px;
  border:none;
  cursor:pointer;
  border-radius:6px;
}
.primary{background:#007bff;color:white;}
.red{background:#dc3545;color:white;}
.blue{background:#007bff;color:white;}
.gray{background:#6c757d;color:white;}

.callBtn{
  background:#25D366;
  font-size:20px;
  padding:18px;
  font-weight:bold;
}

.link{
  text-align:center;
  margin-top:15px;
  color:blue;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="content">YÃ¼kleniyor...</div>

<script>

const API="https://script.google.com/macros/s/AKfycbyu4QtI3rUCXvZMUFwsDFgg9OlFtfbZk7KB8AMkXrwmVLNC7vsSyj-L44Ds1z9a9aZkww/exec";
const id=new URLSearchParams(window.location.search).get("id");

if(!id){
  document.getElementById("content").innerHTML="QR HatalÄ±.";
}else{
  kontrol();
}

function normalizeTel(t){
  t=t.replace(/\D/g,"");
  if(t.startsWith("90")) t=t.slice(2);
  if(!t.startsWith("0")) t="0"+t;
  return t;
}

function normalizePlaka(p){
  return p.toUpperCase().replace(/\s/g,"");
}

function kontrol(){
  fetch(`${API}?action=kontrol&id=${id}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.kayit){
      kayitEkran();
    }else{
      if(d.durum=="pasif"){
        document.getElementById("content").innerHTML=
        "<h2>Bu araÃ§ ÅŸu an iletiÅŸime kapalÄ±.</h2>";
      }else{
        menu(d.plaka,d.telefon);
      }
    }
  })
  .catch(()=>{
    document.getElementById("content").innerHTML="Sunucuya baÄŸlanÄ±lamadÄ±.";
  });
}

function kayitEkran(){
  document.getElementById("content").innerHTML=`
  <h2>KayÄ±t OluÅŸtur</h2>
  <input id="plaka" placeholder="Plaka">
  <input id="ad" placeholder="Ad Soyad">
  <input id="telefon" placeholder="Telefon">
  <input id="sifre" type="password" placeholder="Åžifre">
  <button class="primary" onclick="kaydet()">Kaydet</button>
  `;
}

function kaydet(){

  let tel=normalizeTel(document.getElementById("telefon").value);
  let pl=normalizePlaka(document.getElementById("plaka").value);
  let ad=document.getElementById("ad").value;
  let sifre=document.getElementById("sifre").value;

  fetch(`${API}?action=kayit&id=${id}&plaka=${pl}&ad=${encodeURIComponent(ad)}&telefon=${tel}&sifre=${encodeURIComponent(sifre)}`)
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      alert("KayÄ±t tamamlandÄ±.");
      kontrol();
    }
  });
}

function menu(plaka,tel){

  let mesaj=(text)=>`https://wa.me/${tel}?text=${encodeURIComponent(text)}`;

  document.getElementById("content").innerHTML=`
  <h1>${plaka}</h1>

  <button class="red" onclick="window.location='${mesaj("Acil durum nedeniyle aracÄ±nÄ±za ulaÅŸmaya Ã§alÄ±ÅŸÄ±yorum.")}'">ðŸš¨ Acil Durum</button>

  <button class="blue" onclick="window.location='${mesaj("AracÄ±nÄ±z yanlÄ±ÅŸ park edilmiÅŸ.")}'">ðŸš— YanlÄ±ÅŸ Park</button>

  <button class="blue" onclick="window.location='${mesaj("AracÄ±nÄ±zÄ±n camlarÄ± aÃ§Ä±k kalmÄ±ÅŸ.")}'">ðŸŒ¬ Camlar AÃ§Ä±k</button>

  <a href="tel:${tel}">
    <button class="callBtn">ðŸ“ž HEMEN ARA</button>
  </a>

  <div class="link" onclick="sahipGiris()">AraÃ§ Sahibi GiriÅŸi</div>
  `;
}

function sahipGiris(){
  document.getElementById("content").innerHTML=`
  <h2>AraÃ§ Sahibi</h2>
  <input id="p2" placeholder="Plaka">
  <input id="s2" type="password" placeholder="Åžifre">
  <button class="gray" onclick="durumDegistir()">Aktif / Pasif DeÄŸiÅŸtir</button>
  <button class="primary" onclick="kontrol()">Geri</button>
  `;
}

function durumDegistir(){

  let pl=normalizePlaka(document.getElementById("p2").value);
  let sif=document.getElementById("s2").value;

  fetch(`${API}?action=durum&plaka=${pl}&sifre=${encodeURIComponent(sif)}`)
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      alert("Yeni durum: "+d.yeni);
      kontrol();
    }else{
      alert("Bilgiler hatalÄ±.");
    }
  });
}

</script>

</body>
</html>

