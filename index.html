<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç QR Sistemi</title>

<style>

*{box-sizing:border-box;}

html,body{
  height:100%;
}

body{
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1d2671,#c33764);
  display:flex;
  justify-content:center;
  align-items:center;
  margin:0;
  padding:20px;
}

.card{
  background:#fff;
  padding:30px;
  border-radius:25px;
  width:100%;
  max-width:520px;   /* mobilde daha büyük */
  box-shadow:0 25px 60px rgba(0,0,0,0.35);
}

.plaka{
  font-size:36px;
  font-weight:900;
  text-align:center;
  border:4px solid #1d2671;
  padding:18px;
  border-radius:15px;
  margin-bottom:25px;
  letter-spacing:2px;
}

button{
  width:100%;
  padding:20px;
  margin-top:15px;
  border:none;
  border-radius:15px;
  font-weight:bold;
  font-size:18px;
  cursor:pointer;
}

.ara{
  background:#28a745;
  color:white;
  font-size:22px;
}

.acil{background:#dc3545;color:white;}
.cam{background:#ffc107;}
.park{background:#17a2b8;color:white;}
.toggle{background:#6f42c1;color:white;}

input{
  width:100%;
  padding:16px;
  margin-top:14px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
}

.links{
  margin-top:20px;
  text-align:center;
  font-size:15px;
}

.links span{
  cursor:pointer;
  color:#1d2671;
  font-weight:bold;
  margin:0 12px;
}

.loader{
  text-align:center;
  padding:60px 0;
  font-size:18px;
}

</style>


</head>
<body>
<div class="card" id="app"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwh2J-Z6Qpyrc3rb5jVzQ0DVyiBMb9phYeAqH4fRfCZmtEW2_9duX1WsW6D1o_lEqVXng/exec";
const qr=new URLSearchParams(location.search).get("qr");
const app=document.getElementById("app");
let currentPlaka="";
let currentTelefon="";
let currentDurum="";

if(!qr){ app.innerHTML="<h3>QR bulunamadı</h3>"; }

fetch(API+"?action=get&qr="+qr)
.then(r=>r.json())
.then(d=>{
  if(!d.kayit){
    app.innerHTML=`
      <h3>Kayıt Ol</h3>
      <input id="plaka" placeholder="Plaka">
      <input id="telefon" placeholder="Telefon">
      <input id="sifre" placeholder="Şifre">
      <button onclick="register()">Kaydet</button>
    `;
  }else{
    if(d.durum=="pasif"){
      app.innerHTML=`<div class="plaka">${d.plaka}</div>
      <button onclick="login()">Araç Sahibi Giriş</button>`;
    }else{
      currentPlaka=d.plaka;
      currentTelefon=d.telefon;
      currentDurum=d.durum;
      showButtons();
    }
  }
});

function register(){
  fetch(API+"?action=register",{
    method:"POST",
    body:JSON.stringify({
      qr:qr,
      plaka:document.getElementById("plaka").value,
      telefon:document.getElementById("telefon").value,
      sifre:document.getElementById("sifre").value
    })
  }).then(()=>location.reload());
}

function login(){
  const sifre=prompt("Şifre giriniz:");
  fetch(API+"?action=login",{
    method:"POST",
    body:JSON.stringify({qr:qr,sifre:sifre})
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      currentPlaka=d.plaka;
      currentTelefon=d.telefon;
      currentDurum=d.durum;
      showButtons(true);
    }else{
      alert("Şifre hatalı");
    }
  });
}

function showButtons(owner=false){
  app.innerHTML=`
    <div class="plaka">${currentPlaka}</div>
    <button class="ara" onclick="mesaj('ara')">Sürücüyü Ara</button>
    <button class="acil" onclick="mesaj('acil')">Acil</button>
    <button class="cam" onclick="mesaj('cam')">Cam Açık</button>
    <button class="park" onclick="mesaj('park')">Yanlış Park</button>
    ${owner?'<button class="toggle" onclick="toggle()">Aktif/Pasif Yap</button>':''}
  `;
}

function toggle(){
  fetch(API+"?action=toggle",{
    method:"POST",
    body:JSON.stringify({plaka:currentPlaka})
  }).then(()=>location.reload());
}

function mesaj(tip){
  let m="";
  if(tip=="acil") m=`ACİL DURUM! ${currentPlaka} plakalı aracınızla ilgili acil bir durum var.`;
  if(tip=="cam") m=`Bilgilendirme: ${currentPlaka} plakalı aracınızın camı açık görünüyor.`;
  if(tip=="park") m=`Bilgilendirme: ${currentPlaka} plakalı aracınız hatalı park etmiş olabilir.`;
  if(tip=="ara") m=`${currentPlaka} plakalı aracınızla ilgili iletişim kurulmak isteniyor.`;
  window.location.href="https://wa.me/90"+currentTelefon+"?text="+encodeURIComponent(m);
}
</script>
</body>
</html>


